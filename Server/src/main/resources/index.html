<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="index.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Outlined" rel="stylesheet">
    <script src="https://kit.fontawesome.com/02544ac723.js" crossorigin="anonymous"> </script>

</head>
<body>
  <header>
    <div id="user-tab">
      <span>
        <a href="/connexion/index.html">connect</a>
        <span class="material-symbols-outlined">account_circle</span>
      </span>
    </div>
  </header>

  <div id="page-content">
    <div>
      <div id="material-filter">
        <label>
          Type :
          <select id="filter-type-list">
            <option>Tous</option>
          </select>
        </label>
        <label>
          OS :
          <select id="filter-os-list">
            <option>Tous</option>
          </select>
        </label>
        <label>
          Nom :
          <input type="text">
        </label>
        <label>
          Afficher les appareils réservés :
          <input type="checkbox">
        </label>
        <span>
          <label>
            Reserver du <input type="date">
          </label>
          <label>
            au <input type="date">
          </label>
          <button id="reserve-submit-btn" disabled onclick="reserveSelectedItems()">Reserver</button>
        </span>
      </div>

      <table id="materials-table">
        <thead>
          <tr>
            <th>Id</th>
            <th>Type</th>
            <th>OS</th>
            <th>Réservé par</th>
            <th>le</th>
            <th>
              Réserver
              <input type="checkbox" id="select-all">
            </th>
          </tr>
        </thead>
        <tbody>
          <!-- Populated: devices -->
          <tr>
            <td>1</td>
            <td>PC</td>
            <td>Windows</td>
            <td></td>
            <td></td>
            <td>
              <input type="checkbox">
            </td>
          </tr>
          <tr>
            <td>2</td>
            <td>PC</td>
            <td>Windows</td>
            <td>John Doe </td>
            <td>25/30/22</td>
            <td>
              <input type="checkbox">
            </td>
          </tr>
        </tbody>
      </table>
      <template id="item-template">
        <tr>
          <td id="t-os"></td>
          <td id="t-type"></td>
          <td id="t-name"></td>
          <td id="t-version"></td>
          <td id="t-reference"></td>
        </tr>
      </template>
    </div>
  </div>

  <div id="popup-frame">
    <div id="popup">
      <h5 id="popup-title"></h5>
    </div>
  </div>

  <script>

const table = document.getElementById('materials-table');
const selectAllBtn = document.getElementById('select-all');
const reserveBtn = document.getElementById('reserve-submit-btn');
const filterTypeList = document.getElementById('filter-type-list');
const filterOSList = document.getElementById('filter-os-list');
const itemTemplate = document.querySelector('item-template');

var currentItems = [];
var reservedItemIds = [];

selectAllBtn.addEventListener('change', (e) => {
  const checkboxes = Array.from(table.querySelectorAll('td input[type="checkbox"]'));
  checkboxes.forEach((checkbox) => {
    checkbox.checked = e.target.checked;
    reserveBtn.disabled = !e.target.checked;
  });
});

function refreshCheckboxAll() {
  const checkboxes = Array.from(table.querySelectorAll('td input[type="checkbox"]'));
  const allChecked = Array.from(checkboxes).every((checkbox) => checkbox.checked);
  const anyChecked = Array.from(checkboxes).some((checkbox) => checkbox.checked);
  if(allChecked) {
    selectAllBtn.checked = true;
    selectAllBtn.indeterminate = false;
  } else if(anyChecked) {
    selectAllBtn.checked = false;
    selectAllBtn.indeterminate = true;
  } else {
    selectAllBtn.checked = false;
    selectAllBtn.indeterminate = false;
  }
  reserveBtn.disabled = !anyChecked;
}

function populateItemsTable(items) {
  console.log(items);
  const tbody = table.querySelector('tbody');
  
  // keep reserved items
  for(let item of currentItems) {
    if(reservedItemIds.includes(item.id))
      item.reserved = true;
    tbody.removeChild(item.element);
  }
  currentItems = currentItems.filter(it => reservedItemIds.includes(it.id));

  for(let item of items) {
    if(currentItems.some((i) => i.id === item.id))
      continue;
    let element = itemTemplate.content.cloneNode(true);
    element.querySelector('#t-os').textContent = item.os;
    element.querySelector('#t-type').textContent = item.type;
    element.querySelector('#t-name').textContent = item.name;
    element.querySelector('#t-version').textContent = item.version;
    element.querySelector('#t-reference').textContent = item.numRef;
    element.querySelectorAll('[id]').forEach((el) => el.removeAttribute('id'));
    element.querySelector('input[type=checkbox]').addEventListener('change', (e) => {
      refreshCheckboxAll();
    });
    tbody.appendChild(element);
    currentItems.push({
      id: item.id,
      element: element
    });
  }
}

function populateFilters(typeList, osList) {
  if(filterTypeList.options.length != 1)
    return;
  typeList.forEach((type) => {
    const option = document.createElement('option');
    option.value = type;
    option.innerText = type;
    filterTypeList.appendChild(option);
  });
  osList.forEach((os) => {
    const option = document.createElement('option');
    option.value = os;
    option.innerText = os;
    filterOSList.appendChild(option);
  });
}

function fetchItems(options={}) {
  let xhr = new XMLHttpRequest();
  xhr.open('GET', '/api/list_items');
  xhr.setRequestHeader('Content-Type', 'application/json');
  xhr.send(JSON.stringify(options));
  xhr.onload = () => {
    if (xhr.status != 200) {
      console.log(`Error ${xhr.status}: ${xhr.statusText}`);
      // TODO prompt user with error
    } else {
      const data = JSON.parse(xhr.response);
      populateFilters(data['type-list'], data['os-list']);
      populateItemsTable(data['items']);
    }
  };
}

function reserveSelectedItems() {
  let xhr = new XMLHttpRequest();
  xhr.open('POST', '/api/reserve_items');
  xhr.setRequestHeader('Content-Type', 'application/json');
  xhr.send(JSON.stringify({
  }));
  xhr.onload = () => {
    if (xhr.status != 200) {
      console.log(`Error ${xhr.status}: ${xhr.statusText}`);
      // TODO prompt user with error
    } else {
      const data = JSON.parse(xhr.response);
      console.log(data);
      // TODO prompt user with popup
    }
  };
}

window.addEventListener('load', () => {
  fetchItems();
});

  </script>
</body>
</html>
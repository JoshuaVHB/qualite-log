<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>Donnees utilisateur</title>
	<link rel="stylesheet" href="index.css">

    <script src="https://kit.fontawesome.com/02544ac723.js" crossorigin="anonymous"></script>
</head>
<body>
	<div class="div div1">
		<nav>
			<li class="test"><a href="/accueil">Page d'accueil</a>
			<a href="?logout">Déconnexion   <i class="fa-solid fa-arrow-right-from-bracket"></i></a></li>
		</nav>
	</div>
    <p><h1 class="title">Données de l'utilisateur</h1></p>
    <div id="container">
        <div>
            <form class="forminscription" method="GET" id="changeUser" action="UPDATE">
                <label class="label lab1" for="role">
                    <input type="checkbox" id="role" class="inputData" disabled="disabled">Utilisateur est un administrateur
                </label><br />
                <label class="label lab1" for="First-name">
                    Matricule <input class="inputData" type="text" name="matricule" id="matricule" disabled="disabled"><br>
                </label>
                <label class="label lab1" for="Last-name">
                    Prenom <input class="inputData" type="text" name="prenom" id="prenom" disabled="disabled"><br>
                </label>
                <label class="label lab1" for="First-name">
                    Nom <input class="inputData" type="text" name="nom" id="nom" disabled="disabled"><br>
                </label>

                <label class="label lab1" for="email">
                    Email <input class="inputData" type="email" name="email" id="email" disabled="disabled"><br>
                </label>
            </form>
        </div>
        <div>
            <button id="changeData" class="connectButt" onclick="changeData();">
                Modifier
            </button>
        </div>
        <div id="popup-frame" hidden>
            <div id="popup">
                <h5 id="popup-title"></h5>
                <button onclick="popupFrame.hidden = true;">Ok</button>
            </div>
        </div>
    </div>
</body>
</html>
<script>
    const popupFrame = document.getElementById('popup-frame');

    const urlParams = new URLSearchParams(window.location.search);
    let id = urlParams.get('id');
    if (id) {
        document.getElementById('matricule').value = id;
    } else {
        document.getElementById('matricule').value = "";
    }
    
    
    const elements = document.getElementsByClassName('inputData');

    function populateData(users) {
        for (let user of users) {
            if (user.id == id) {
                dataUser(user);
            }
        }
    }

    function dataUser(user) {
        document.getElementById('role').checked = user.isAdmin;

        document.getElementById('matricule').value = user.id;
        document.getElementById('prenom').value = user.name;
        document.getElementById('nom').value = user.name;
        document.getElementById('email').value = user.email;
    }

    function fetchUsers() {

        if (id) {
            fetch('/api/list_users', {
                method: 'POST',
            }).then((response) => {
                if (response.ok)
                    return response.json();
                else
                    throw new Error('Could not fetch items');
            }).then((data) => {
                populateData(data.items);
            }).catch((err) => {
                console.error(err);
                popupFrame.hidden = false;
                popupFrame.querySelector('#popup-title').innerText = err.message;
            });
        }
        else {
            fetch('/profil_item', {
                method: 'POST',
            }).then((response) => {
                if (response.ok)
                    return response.json();
                else
                    throw new Error('Could not fetch items');
            }).then((data) => {
                dataUser(data.items);
            }).catch((err) => {
                console.error(err);
                popupFrame.hidden = false;
                popupFrame.querySelector('#popup-title').innerText = err.message;
            });
        }
        
    }

    window.addEventListener('load', () => {
        fetchUsers();
    });

    
    function changeData() {
        if (document.getElementById('changeData').innerText == 'Modifier') {
            document.getElementById('changeData').innerText = 'Valider';
            
            for (let elem of elements) {
                elem.disabled = false;
            }
        }
        else {
            validateData();
            document.getElementById('changeData').innerText = 'Modifier';
            for (let elem of elements) {
                elem.disabled = true;
            }
        }
        
    }

    function validateData() {
        var user = new FormData(document.getElementById("changeUser"));

        let url = '/api/updateMateriel';
        let params = user;
        let xhr = new XMLHttpRequest();
        xhr.open('GET', url, true);
        xhr.send(params);
        xhr.onload = () => {
            if (xhr.status == 200) {
                console.log("Response =", xhr.responseText);
                // do something with the data
            } else {
                throw new Error("Could not fetch ");
            }
        };
    }
</script>